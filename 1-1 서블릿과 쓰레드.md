# Chapter1
## 웹 어플리케이션 서버에서 처리하는 업무
- 서버 TCP/IP 연결 대기, 소켓 연결
- HTTP 요청 메세지 파싱해서 읽기
- HTTP Method, URL 판독
- Content-Type 확인
- HTTP 메세지 바디 내용 파싱
- 저장 프로세스 실행
- 비즈니스 로직 실행
    - DB 저장 요청 수행
- HTTP 응답 메세지 생성
    - HTTP 시작 라인 생성
    - Header 생성
    - 메시지 바디에 HTML 생성해서 입력
- TCP/IP 에 응답 전달, 소켓 종료
  
  ## Servlet
- Servlet은 이 중 비즈니스 로직 실행 이외의 과정들을 대신 처리해준다
- 사용하기 위해서는 기본적인 HTTP 스펙을 알아야 한다
- HttpServletRequest, HttpServletResponse 객체를 이용하여 HTTP Request, Response 정보에 접근할 수 있다
- Http 요청을 처리하기 위해서는 HttpServelt 클래스 상속 필요
## Servlet의 HTTP 요청, 응답 흐름
  - HTTP Request를 기반으로 Request, Response 객체 새로 생성
  - WAS 내 서블릿 컨테이너에서 Request, Response 객체를 매개변수로 하는 서블릿 객체 호출
  - Request 객체에서 HTTP Request 정보를 꺼내서 사용
  - Response 객체에 HTTP Response 정보 입력
  - Servlet은 Response 객체에 담겨있는 내용으로 HTTP응답 정보를 생성

## Servlet Container
- HttpServlet을 상속한 서블릿 객체를 관리(생성, 호출, 삭제 등의 라이프 사이클 관리)
- 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 함
- 서블릿 객체는 싱글톤으로 관리함
    - HttpServletRequest, HttpServletResponse 객체는 싱글톤 아님
    - 요청이 생길 때마다 계속 객체를 생성하는것이 비효율적이기 때문이다
    - 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
    - 동일한 URL로의 요청은 동일한 서블릿 객체 인스턴스에 접근함
    - 서블릿 컨테이너 종료시 함께 종료됨
    - 공유 변수 사용에 주의해야함
- JSP도 Servlet으로 변환되어서 사용한다
- 동시 요청을 위한 멀티 스레드 처리를 지원해줌
  
## 동시 요청 - 멀티 쓰레드

### 쓰레드
- 하나의 프로세스 내에서 작업을 실행하는 주체
  - 어플리케이션 코드를 순차적으로 한 줄씩 실행 
- 자바 main 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행됨
- 쓰레드가 없다면 자바 어플리케이션 실행이 불가능
- 동시 처리가 필요하면 쓰레드를 추가로 생성해야함

### Servlet에서의 쓰레드 사용
- 단일 쓰레드만 사용하는 방식
  - 요청이 오면 쓰레드를 서블릿 객체에 할당하고, 요청을 처리한 뒤 쓰레드를 제거함
  - 단일 쓰레드 상황에서 하나의 요청이 처리가 지연되고 있을 때, 해당 객체로 또 다른 요청이 들어오게 되면 두 요청 모두 처리에 실패하게 된다 (timeout 에러)
  - 이를 해결하기 위해 매 요청마다 쓰레드를 새로 생성해서 할당해줄 수 있다

- 요청마다 쓰레드 생성을 하는 방식
  - 장점
    - 동시 요청을 처리 가능
    - 리소스 허용치까지 처리 가능
    - 하나의 쓰레드가 지연되어도 나머지 쓰레드는 정상 동작
  - 단점
    - 쓰레드 생성 비용이 비쌈
        - 요청마다 쓰레드 생성하면 응답 속도 지연됨
    - 컨텍스트 스위칭 비용이 발생
        - 컨텍스트 스위칭은 시분할로 쓰레드를 실행할 때 쓰레드 전환 과정을 말한다
    - 생성에 제한이 없음
        - 리소스 한계점 이상으로 쓰레드가 생성되면 서버가 종료될 수 있다
    - 단점 해결을 위해 쓰레드 풀을 사용함

- 쓰레드 풀을 사용하는 방식
  - 쓰레드 풀
    - 미리 쓰레드를 여러개 만들어두고 이를 관리하는 것
    - 쓰레드 풀에 생성가능한 쓰레드의 최대치를 관리할 수 있음 (톰캣은 최대 200개가 기본,  설정으로 변경 가능하다)
      - application.properties 파일의 server.tomcat.threads.max 항목 작성
      - 자세한 설정 사항은 https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.server 참고
      - 750 이상으로 쓰레드 풀을 설정할 경우 WAS를 두개 이상 가동하는 방식 권장
        - 출처: https://newstars.cloud/302
    - 요청마다 쓰레드 생성하는 방식의 단점을 보완하기 위해서 사용

- 사용 방식
    - 요청이 올 때마다 쓰레드 풀에서 쓰레드를 분배해주는 방식으로 사용
    - 요청에 대한 응답까지 모두 끝나면 쓰레드를 쓰레드 풀에 반납함
    - 쓰레드 풀이 고갈되었을 경우, 쓰레드를 대기하거나 요청을 거절한다
        - 쓰레드를 대기하는것은 쓰레드 풀에 쓰레드가 반납되는 것을 대기한다는 의미이다
        - 요청을 거절하는 것은 쓰레드 풀이 고갈되었을 때 들어온 요청을 거부하는 것이다
        - 쓰레드 대기의 경우 몇개의 요청까지 대기시키고 그 이외의 요청을 거부할지 설정할 수 있음
          - application.properties의 server.tomcat.accept-count 항목 작성 (기본값 100)
- 장점
    - 쓰레드가 미리 생성되어 있기 때문에 쓰레드 생성, 종료하는 비용(CPU 연산)이 절약되고 응답 시간이 빠름
    - 생성 가능한 쓰레드 최대치가 존재하므로 너무 많은 요청을 받아도 기존 요청은 안전하게 처리할 수 있음
- 실제 업무에서 사용 시 주의할 점
    - WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수
    - 값이 너무 낮을 경우
        - 동시 요청이 많을 시, 서버 리소스는 여유가 있으나 클라이언트에서 응답 지연이 발생
    - 값이 너무 높을 경우
        - 동시 요청이 많을 시, 리소스 한계 초과로 서버가 다운됨
    - 장애 발생 시
        - 클라우드상에서 운영하는 경우, 서버를 늘린 뒤 이후 WAS 튜닝
            - 서비스 접속 지연을 해결해야하기 때문
        - 직접 서버를 두고 운영하는 경우, WAS 튜닝을 우선 진행
            - 서버 증설에 물리적인 시간이 소비
    - 쓰레드풀의 적정 숫자
        - 어플리케이션 로직의 복잡도, CPU, Memory, IO Resource 상황에 따라 모두 다름
        - 적정 숫자를 찾기 위해 성능 테스트를 시도할 수 있음
            - 최대한 실제 서비스와 유사하게 성능 테스트를 시도함
            - Apache ab, Apache Jmeter, nCrinder
            - 테스트를 통해 병목 지점등을 찾아 성능을 개선할 수 있음
- WAS의 멀티 쓰레드 지원
    - 멀티 쓰레드에 대한 부분은 WAS가 처리
    - 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
        - 멀티 쓰레드를 신경쓰게 되면 그에 관한 개념과 구현까지 손을 대야 함
    - 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 펀리하게 소스코드를 개발 가능
    - 멀티 쓰레드 환경이기 때문에 싱글톤 객체는 주의해서 사용해야함 (멤버 변수가 공유되기 때문에 이를 주의해야함)
