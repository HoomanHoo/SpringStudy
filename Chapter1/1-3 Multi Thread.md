# 동시 요청 - 멀티 쓰레드

## 쓰레드

- 어플리케이션 코드를 하나씩 순차적으로 실행함
- 자바 main 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행됨
- 쓰레드가 없다면 자바 어플리케이션 실행이 불가능
- 쓰레드는 한 번에 하나의 코드 라인만 수행
- 동시 처리가 필요하면 쓰레드를 추가로 생성해야함
- 요청이 오면 쓰레드를 서블릿 객체에 할당하고, 요청을 처리한 뒤 쓰레드를 제거함
- 단일 쓰레드 상황에서 하나의 요청이 처리가 지연되고 있을 때, 해당 객체로 또 다른 요청이 들어오게 되면 두 요청 모두 처리에 실패하게 된다 (timeout 에러)
- 이를 해결하기 위해 매 요청마다 쓰레드를 새로 생성해서 할당해줄 수 있다

## 요청마다 쓰레드 생성

장점

- 동시 요청을 처리 가능
- 리소스 허용치까지 처리 가능
- 하나의 쓰레드가 지연되어도 나머지 쓰레드는 정상 동작

단점

- 쓰레드 생성 비용이 비쌈
    - 요청마다 쓰레드 생성하면 응답 속도 지연됨
- 컨텍스트 스위칭 비용이 발생 (컨텍스트 스위칭?)
    - 컨텍스트 스위칭은 시분할로 쓰레드를 실행할 때 쓰레드 전환 과정을 말한다
- 생성에 제한이 없음
    - 리소스 한계점 이상으로 쓰레드가 생성되면 서버가 종료될 수 있다
- 단점 해결을 위해 쓰레드 풀을 사용함

## 쓰레드 풀

- WAS에서 요청마다 쓰레드 생성하는 방식의 단점을 보완하기 위해서 사용
- 특징
    - 미리 쓰레드를 여러개 만들어두고 이를 관리하는 것
    - 쓰레드 풀에 생성가능한 쓰레드의 최대치를 관리할 수 있음 (톰캣은 최대 200개가 기본 설정으로 변경 가능하다)
- 사용 방식
    - 요청이 올 때마다 쓰레드 풀에서 쓰레드를 분배해주는 방식으로 사용
    - 요청에 대한 응답까지 모두 끝나면 쓰레드를 쓰레드 풀에 반납함
    - 쓰레드 풀이 고갈되었을 경우, 쓰레드를 대기하거나 요청을 거절한다
        - 쓰레드를 대기하는것은 쓰레드 풀에 쓰레드가 반납되는 것을 대기한다는 의미이다
        - 요청을 거절하는 것은 쓰레드 풀이 고갈되었을 때 들어온 요청을 거부하는 것이다
        - 쓰레드 대기의 경우 몇개의 요청까지 대기시키고 그 이외의 요청을 거부할지 설정할 수 있음
- 장점
    - 쓰레드가 미리 생성되어 있기 때문에 쓰레드 생성, 종료하는 비용(CPU 연산)이 절약되고 응답 시간이 빠름
    - 생성 가능한 쓰레드 최대치가 존재하므로 너무 많은 요청을 받아도 기존 요청은 안전하게 처리할 수 있음
- 실제 업무에서 사용 시 주의할 점
    - WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수
    - 값이 너무 낮을 경우
        - 동시 요청이 많을 시, 서버 리소스는 여유가 있으나 클라이언트에서 응답 지연이 발생
    - 값이 너무 높을 경우
        - 동시 요청이 많을 시, 리소스 한계 초과로 서버가 다운됨
    - 장애 발생 시
        - 클라우드상에서 운영하는 경우, 서버를 늘린 뒤 이후 WAS 튜닝
            - 서비스 접속 지연을 해결해야하기 때문
        - 직접 서버를 두고 운영하는 경우, WAS 튜닝을 우선 진행
            - 서버 증설에 물리적인 시간이 소비
    - 쓰레드풀의 적정 숫자
        - 어플리케이션 로직의 복잡도, CPU, Memory, IO Resource 상황에 따라 모두 다름
        - 적정 숫자를 찾기 위해 성능 테스트를 시도할 수 있음
            - 최대한 실제 서비스와 유사하게 성능 테스트를 시도함
            - Apache ab, Apache Jmeter, nCrinder
            - 테스트를 통해 병목 지점등을 찾아 성능을 개선할 수 있음
- WAS의 멀티 쓰레드 지원
    - 멀티 쓰레드에 대한 부분은 WAS가 처리
    - 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
        - 멀티 쓰레드를 신경쓰게 되면 그에 관한 개념과 구현까지 손을 대야 함
    - 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 펀리하게 소스코드를 개발 가능
    - 멀티 쓰레드 환경이기 때문에 싱글톤 객체는 주의해서 사용해야함 (멤버 변수가 공유되기 때문에 이를 주의해야함)